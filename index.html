<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manga Library</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020; --fg:#e9edf5; --muted:#a9b2c2; --accent:#7aa2ff;
  --glass:rgba(255,255,255,.07); --glass-strong:rgba(255,255,255,.10);
  --radius:16px; --blur:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --sidebar-w:320px; --scrim:rgba(0,0,0,.45);
}
body.light{
  --bg:#e9eef7; --fg:#0b1222; --muted:#44506a; --accent:#2b6fff;
  --glass:rgba(255,255,255,.65); --glass-strong:rgba(255,255,255,.75);
  --shadow:0 10px 26px rgba(0,0,0,.18);
}
html,body{height:100%}
body {
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  letter-spacing: .2px;
  transition: background .25s ease, color .25s ease;
}

.container-narrow{max-width:1280px; margin:0 auto; padding:18px;}
.app-layout{position:relative}

/* Glass */
.glass{
  background:var(--glass);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(var(--blur)) saturate(135%);
  -webkit-backdrop-filter: blur(var(--blur)) saturate(135%);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* Sidebar */
.sidebar{
  position:fixed;
  top:0; left:0; bottom:0;
  width:var(--sidebar-w);
  padding:16px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:stretch;
  gap:16px;
  transform:translateX(-100%);
  transition:transform .25s ease;
  z-index:1001;
}
.sidebar.open{ transform:translateX(0); }
.scrim{
  position:fixed; inset:0; background:var(--scrim);
  opacity:0; visibility:hidden;
  transition:opacity .2s ease, visibility .2s ease;
  z-index:1000;
}
.scrim.show{ opacity:1; visibility:visible; }
#openAdd { width:100%; flex:0 0 auto; padding:8px 12px; font-weight:500; }

/* Logo */
.logo-row{ display:flex; align-items:center; gap:10px; padding:6px 8px; }
.logo-mark{ width:28px; height:28px; border-radius:8px;
  background:linear-gradient(135deg, var(--accent), transparent);
  border:1px solid rgba(255,255,255,.25);
}
.logo-text{ font-weight:700; letter-spacing:.3px; }
.panel{ padding:12px; }
.panel .label{ font-size:12px; color:var(--muted); margin-bottom:6px }

/* Theme switch */
.switch-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.switch{ position:relative; width:48px; height:26px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; inset:0; cursor:pointer; background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.2); border-radius:999px; transition:background .2s ease, border-color .2s ease;
}
.slider:before{
  content:""; position:absolute; height:20px; width:20px; left:3px; top:50%;
  transform:translateY(-50%); background:#fff; border-radius:50%; transition:transform .2s ease;
}
.switch input:checked + .slider{ background:rgba(122,162,255,.35); border-color:rgba(122,162,255,.65); }
.switch input:checked + .slider:before{ transform:translate(21px,-50%); }

/* Topbar */
.topbar{ position:sticky; top:8px; z-index:5; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; }
.brand-btn{
  display:flex; align-items:center; gap:10px; background:transparent; border:none; color:inherit;
  cursor:pointer; padding:6px 8px; border-radius:10px;
}
.brand-btn:hover{ background:rgba(255,255,255,.1); }
.brand-text{ font-weight:700; letter-spacing:.4px; }

/* Grid layout */
.grid {
  display: grid;
  gap: 16px;
  margin-top: 16px;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
}

/* Card */
.cardx {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  border-radius: 16px;
  background: var(--glass);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow);
  transition: transform .18s ease, box-shadow .18s ease;
  height: 100%;
  min-height: 400px;
}
.cardx:hover{ transform: translateY(-4px); }

.thumb { aspect-ratio: 3 / 4; overflow: hidden; border-bottom: 1px solid rgba(255,255,255,.1); }
.thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
.thumb.placeholder { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); }
.thumb.placeholder::after { content:"üñºÔ∏è"; position:absolute; inset:0; display:grid; place-items:center; font-size:28px; opacity:.6; }

.card-bodyx { flex:1 1 auto; display:flex; flex-direction:column; justify-content:space-between; padding:10px 12px 12px; }
.title { font-size:14px; font-weight:600; line-height:1.25; margin:0 0 4px 0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.info-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.meta { font-size:12px; color:var(--muted); }
.status-pill { padding:3px 8px; border-radius:999px; background:rgba(255,255,255,.07); font-size:11.5px; }

/* Actions */
.actions { display:flex; gap:6px; margin-top:auto; }
.btnx {
  flex:1; height:36px; display:flex; align-items:center; justify-content:center;
  border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05); color:var(--fg); font-size:.9rem;
  cursor:pointer; transition:background .15s ease,border-color .15s ease, box-shadow .15s ease;
  padding:0 10px;
}
.btnx:hover{ background:rgba(255,255,255,.09); }
.btn-dangerx{ border-color:rgba(255,60,60,.45); color:#ff5b5b; }
.btn-dangerx:hover{ box-shadow:0 0 12px rgba(255,60,60,.6); }
.btnx svg{ width:16px; height:16px; display:block; }

/* Modals, Toasts and Misc */
.modal-scrim, .del-scrim{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);opacity:0;visibility:hidden;transition:opacity .2s ease,visibility .2s ease;z-index:1000;}
.modal-scrim.show,.del-scrim.show{opacity:1;visibility:visible;}
.modalx,.del-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-48%) scale(.98);width:min(560px,92vw);z-index:1001;opacity:0;visibility:hidden;transition:opacity .2s ease,transform .2s ease,visibility .2s ease;}
.modalx.show,.del-modal.show{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1);}
.glass-toast-wrap{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:1300;display:flex;flex-direction:column;gap:8px;align-items:center;}
.glass-toast{min-width:200px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(10px);color:inherit;font-weight:600;opacity:0;transform:translateY(8px);transition:opacity .3s ease,transform .3s ease;}
.glass-toast.show{opacity:1;transform:translateY(0);}
.toast-success{background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.4);color:#22c55e;}
.toast-danger{background:rgba(239,68,68,0.25);border-color:rgba(239,68,68,0.45);color:#ef4444;}
.text-mutedx{color:var(--muted);}
.hidden{display:none;}
</style>
</head>
<body>
<!-- Sidebar -->
<aside id="sidebar" class="sidebar glass">
  <div class="logo-row"><div class="logo-mark"></div><div class="logo-text">Manga Library</div></div>
  <div class="glass panel"><div class="label">Theme</div>
    <div class="switch-row"><span class="text-mutedx">Toggle</span>
      <label class="switch"><input type="checkbox" id="themeSwitch"><span class="slider"></span></label>
    </div>
  </div>
  <div class="glass panel" id="userPanel"><div class="label">Account</div>
    <div id="userEmail" class="mb-2 text-truncate"></div>
    <button id="logoutBtn" class="btnx w-100">Logout</button>
  </div>
  <button id="openAdd" class="btnx hidden">Add</button>
  <div class="text-mutedx mt-auto">&copy; <span id="year"></span> Manga Library</div>
</aside>
<div id="scrim" class="scrim"></div>

<!-- Add Modal -->
<div id="modalScrim" class="modal-scrim"></div>
<div id="addModal" class="modalx">
  <div class="glass p-3">
    <h5>Add Series</h5>
    <input id="m_title" class="form-control mb-2" placeholder="Title">
    <input id="m_chapter" class="form-control mb-2" placeholder="Chapter" type="number">
    <select id="m_status" class="form-select mb-2"><option>Ongoing</option><option>Completed</option></select>
    <input id="m_url" class="form-control mb-2" placeholder="URL">
    <input id="m_cover" class="form-control mb-2" placeholder="Cover URL">
    <div class="d-flex justify-content-end gap-2">
      <button id="cancelAdd" class="btnx">Cancel</button>
      <button id="saveAdd" class="btnx">Save</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="delScrim" class="del-scrim"></div>
<div id="delModal" class="del-modal">
  <div class="glass p-3">
    <h5>Delete Entry</h5>
    <p class="text-mutedx">Are you sure you want to delete this entry? This action cannot be undone.</p>
    <div class="d-flex justify-content-end gap-2">
      <button id="delCancel" class="btnx">Cancel</button>
      <button id="delConfirm" class="btnx btn-dangerx">Delete</button>
    </div>
  </div>
</div>

<div id="toastWrap" class="glass-toast-wrap"></div>

<div class="container-narrow app-layout">
  <header class="topbar glass">
    <button id="openSidebar" class="brand-btn"><div class="logo-mark"></div><span class="brand-text">Manga Library</span></button>
  </header>

  <div id="auth"></div>
  <section id="app" class="hidden">
    <div class="glass p-3 mt-3 d-flex flex-wrap gap-2">
      <input id="searchInput" class="form-control flex-grow-1" placeholder="Search...">
      <select id="statusFilter" class="form-select w-auto"><option value="">All</option><option value="Ongoing">Ongoing</option><option value="Completed">Completed</option></select>
      <button id="refreshBtn" class="btnx">Refresh</button>
    </div>
    <div id="resultCount" class="text-mutedx mt-2">Loading...</div>
    <div id="grid" class="grid"></div>
  </section>
</div>

<script>
const SUPABASE_URL="https://qdbfokgiwrococaxifkn.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkYmZva2dpd3JvY29jYXhpZmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDU0MTcsImV4cCI6MjA3NzkyMTQxN30.rQz9t-NnU_Ahn-8avkUlhry4BFYyw6PVfgZNo-KFK1A";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const $=(s,p=document)=>p.querySelector(s);
const el={sidebar:$("#sidebar"),scrim:$("#scrim"),openSidebar:$("#openSidebar"),themeSwitch:$("#themeSwitch"),userEmail:$("#userEmail"),logoutBtn:$("#logoutBtn"),openAdd:$("#openAdd"),modalScrim:$("#modalScrim"),addModal:$("#addModal"),saveAdd:$("#saveAdd"),cancelAdd:$("#cancelAdd"),m_title:$("#m_title"),m_chapter:$("#m_chapter"),m_status:$("#m_status"),m_url:$("#m_url"),m_cover:$("#m_cover"),delScrim:$("#delScrim"),delModal:$("#delModal"),delCancel:$("#delCancel"),delConfirm:$("#delConfirm"),toastWrap:$("#toastWrap"),auth:$("#auth"),app:$("#app"),grid:$("#grid"),search:$("#searchInput"),status:$("#statusFilter"),refresh:$("#refreshBtn"),resultCount:$("#resultCount")};
$("#year").textContent=new Date().getFullYear();
function openSidebar(){el.sidebar.classList.add("open");el.scrim.classList.add("show");}
function closeSidebar(){el.sidebar.classList.remove("open");el.scrim.classList.remove("show");}
el.openSidebar.onclick=openSidebar;el.scrim.onclick=closeSidebar;

/* Theme persistence */
(function(){const t=localStorage.getItem("theme")||"dark";setTheme(t);el.themeSwitch.checked=t==="light";el.themeSwitch.onchange=()=>{const m=el.themeSwitch.checked?"light":"dark";setTheme(m);localStorage.setItem("theme",m);};function setTheme(m){m==="light"?document.body.classList.add("light"):document.body.classList.remove("light");}})();

/* Auth + load */
let cache=[],userId=null,pendingDelete=null;
initAuth();
async function initAuth(){const {data:{session}}=await supabase.auth.getSession();renderAuth(session?.user||null);supabase.auth.onAuthStateChange((_e,s)=>renderAuth(s?.user||null));}
function renderAuth(u){if(u){userId=u.id;el.userEmail.textContent=u.email;el.logoutBtn.onclick=async()=>{await supabase.auth.signOut();location.reload();};el.auth.innerHTML="";el.app.classList.remove("hidden");el.openAdd.classList.remove("hidden");el.openAdd.onclick=openAddModal;wire();loadData();}else{el.app.classList.add("hidden");el.openAdd.classList.add("hidden");el.auth.innerHTML=`<div class="glass p-3 mt-3"><h5>Login or Sign Up</h5><input id="email" class="form-control mb-2" placeholder="Email"><input id="password" type="password" class="form-control mb-2" placeholder="Password"><div class="d-flex gap-2"><button id="login" class="btnx flex-fill">Login</button><button id="signup" class="btnx flex-fill">Sign Up</button></div></div>`;$("#login").onclick=login;$("#signup").onclick=signup;}}
async function login(){const e=$("#email").value.trim(),p=$("#password").value.trim();const{error}=await supabase.auth.signInWithPassword({email:e,password:p});if(error)alert(error.message);}
async function signup(){const e=$("#email").value.trim(),p=$("#password").value.trim();const{error}=await supabase.auth.signUp({email:e,password:p});if(error)alert(error.message);else alert("Check your email to verify, then log in.");}

/* CRUD */
function wire(){el.refresh.onclick=loadData;el.search.oninput=()=>apply();el.status.onchange=apply;}
async function loadData(){el.resultCount.textContent="Loading...";const{data,error}=await supabase.from("manga").select("*").eq("user_id",userId).order("title",{ascending:true});if(error)return console.error(error);cache=data||[];apply();}
function apply(){const q=el.search.value.toLowerCase();const s=el.status.value;let r=cache.filter(x=>x.title.toLowerCase().includes(q));if(s)r=r.filter(x=>(x.status||"")===s);render(r);el.resultCount.textContent=`${r.length} result${r.length!==1?"s":""}`;}
function render(rows){el.grid.innerHTML="";for(const row of rows){const c=document.createElement("div");c.className="cardx";const t=document.createElement("div");t.className="thumb";const a=document.createElement("a");a.href=row.url||"#";a.target="_blank";const i=document.createElement("img");if(row.cover_url){i.dataset.src=row.cover_url;i.loading="lazy";i.alt=row.title;observer.observe(i);}else t.classList.add("placeholder");a.append(i);t.append(a);const b=document.createElement("div");b.className="card-bodyx";const ti=document.createElement("h3");ti.className="title";ti.textContent=row.title;const inf=document.createElement("div");inf.className="info-row";inf.innerHTML=`<div class='meta'>Ch ${row.chapter||0}</div><span class='status-pill'>${row.status||"Ongoing"}</span>`;const act=document.createElement("div");act.className="actions";const plus=btn("+1"),set=btn("Set"),done=btn("Done"),del=btnSvg();plus.onclick=()=>updChap(row.id,(row.chapter||0)+1);set.onclick=()=>{const v=prompt("Set chapter:",row.chapter);if(v!==null)updChap(row.id,Number(v));};done.onclick=()=>markDone(row.id);del.onclick=()=>openDel(row.id);act.append(plus,set,done,del);b.append(ti,inf,act);c.append(t,b);el.grid.append(c);} }
const observer=new IntersectionObserver(e=>{e.forEach(x=>{if(x.isIntersecting){x.target.src=x.target.dataset.src;observer.unobserve(x.target);}})},{rootMargin:"200px"});
function btn(t){const b=document.createElement("button");b.className="btnx";b.textContent=t;return b;}
function btnSvg(){const b=document.createElement("button");b.className="btnx btn-dangerx";b.innerHTML=`<svg xmlns='http://www.w3.org/2000/svg' fill='currentColor' viewBox='0 0 24 24'><path d='M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 1 1 0 2h-1v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7H4a1 1 0 1 1 0-2h4V4a1 1 0 0 1 1-1zm1 4v12h4V7h-4z'/></svg>`;return b;}
async function updChap(id,val){await supabase.from("manga").update({chapter:val}).eq("id",id);loadData();}
async function markDone(id){await supabase.from("manga").update({status:"Completed"}).eq("id",id);loadData();}
async function del(id){await supabase.from("manga").delete().eq("id",id);loadData();toast("Deleted successfully","danger");}

/* Add modal */
function openAddModal(){el.modalScrim.classList.add("show");el.addModal.classList.add("show");}
function closeAddModal(){el.modalScrim.classList.remove("show");el.addModal.classList.remove("show");}
el.cancelAdd.onclick=closeAddModal;el.modalScrim.onclick=closeAddModal;
el.saveAdd.onclick=async()=>{const title=el.m_title.value.trim();if(!title)return alert("Title required");const chapter=Number(el.m_chapter.value)||0;const status=el.m_status.value;const url=el.m_url.value.trim()||null;const cover=el.m_cover.value.trim()||null;let source=null;if(url){try{source=new URL(url).hostname}catch{source=null}}await supabase.from("manga").insert({user_id:userId,title,chapter,status,url,cover_url:cover,source});closeAddModal();loadData();toast("Series added successfully","success");};

/* Delete modal */
function openDel(id){pendingDelete=id;el.delScrim.classList.add("show");el.delModal.classList.add("show");}
function closeDel(){el.delScrim.classList.remove("show");el.delModal.classList.remove("show");}
el.delCancel.onclick=closeDel;el.delScrim.onclick=closeDel;
el.delConfirm.onclick=async()=>{if(!pendingDelete)return;await supabase.from("manga").delete().eq("id",pendingDelete);if(navigator.vibrate)navigator.vibrate(40);closeDel();loadData();toast("Deleted successfully","danger");};

/* Toasts */
function toast(msg,type){const t=document.createElement("div");t.className=`glass-toast ${type==="danger"?"toast-danger":"toast-success"}`;t.textContent=msg;el.toastWrap.append(t);requestAnimationFrame(()=>t.classList.add("show"));setTimeout(()=>{t.classList.remove("show");setTimeout(()=>t.remove(),300)},2000);}
</script>
</body>
</html>
